
Phase 10: Server-Side Generation (Supabase Edge Version)
1. The Architecture Switch
Runtime: Deno (Supabase Edge Runtime).
Library: We will use og_edge (a Deno port of @vercel/og) or standard satori loaded via CDN.
Benefit: 500,000 invocations/month for free (vs Vercel's limits).
2. Technical Setup
A. Initialize the Function
Run this command in your project terminal:

Bash
supabase functions new og-generator
This creates a file at ./supabase/functions/og-generator/index.ts.

B. The Deno Import Strategy
Deno doesn't use npm install. You import directly from URLs. You will need:
React: For the JSX templates.
ImageResponse: To render the image.
Top of file imports:

TypeScript
import React from 'https://esm.sh/react@18.2.0?deno-std=0.140.0';
import { ImageResponse } from 'https://deno.land/x/og_edge/mod.ts';
3. The Implementation Logic
Step 1: The Handler
Supabase functions use Deno.serve.

TypeScript
Deno.serve(async (req) => {
  // 1. Parse URL parameters
  const url = new URL(req.url);
  const title = url.searchParams.get('title') || 'My Banner';
  const bgUrl = url.searchParams.get('bg_url');

  // 2. Fetch Assets (The "Black Void" Fix)
  // We must fetch the font and image as ArrayBuffers here
  const fontData = await fetch(
    new URL('../../assets/Inter-Bold.ttf', import.meta.url)
  ).then((res) => res.arrayBuffer());

  const bgImageData = await fetch(bgUrl).then((res) => res.arrayBuffer());

  // 3. Render
  return new ImageResponse(
    (
      <div
        style={{
          height: '100%',
          width: '100%',
          display: 'flex',
          backgroundImage: `url(${bgUrl})`, // Or use the ArrayBuffer if needed
          color: 'white',
        }}
      >
        <h1>{title}</h1>
      </div>
    ),
    {
      width: 1584,
      height: 396,
      fonts: [
        {
          name: 'Inter',
          data: fontData,
          style: 'normal',
          weight: 700,
        },
      ],
    }
  );
});
Step 2: Handling Fonts in Supabase
You cannot easily "import" a local font file in Edge Functions unless you include it in the deployment.
Strategy: Put your .ttf file inside the supabase/functions/og-generator/ folder.
Loading: Use import.meta.url to resolve the path relative to the executing script.
4. Deployment & URL Structure
A. Deploy
Bash
supabase functions deploy og-generator --no-verify-jwt
--no-verify-jwt: Crucial. This makes the endpoint public so your users' browsers can fetch the image without needing an auth header.
B. The New Download Link
Your frontend link changes to point to your Supabase project URL:

JavaScript
<a
  href={`https://[YOUR_REF].supabase.co/functions/v1/og-generator?title=...`}
  download="banner.png"
>
  Download High-Res
</a>